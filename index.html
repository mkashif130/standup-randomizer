<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stand‚Äëup Randomizer</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--ring:rgba(59,130,246,.5)}
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    /* Toast container */
    #toastWrap{position:fixed;top:12px;right:12px;z-index:50;display:flex;flex-direction:column;gap:.5rem}
    .toast{animation:fadeSlide .25s ease-out;}
    @keyframes fadeSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
    /* Chip X button look */
    .chip-x{display:inline-flex;align-items:center;justify-content:center;width:1.25rem;height:1.25rem;border-radius:.375rem;border:1px solid rgb(203 213 225);background:white;transition:.15s;}
    .chip-x:hover{background:rgb(248 250 252)}
    .chip-x:focus-visible{outline:2px solid var(--ring);outline-offset:1px}
    .chip{gap:.375rem}
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <!-- Toasts -->
  <div id="toastWrap"></div>

  <div class="max-w-5xl mx-auto p-4 md:p-6 lg:p-8">
    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold">Stand‚Äëup Randomizer</h1>
      <div class="flex items-center gap-2">
        <select id="teamSelect" class="w-56 bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Select team"></select>
        <button class="px-3 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500" onclick="newTeam()">New</button>
        <button class="px-3 py-2 text-sm rounded-lg bg-slate-800 text-white hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-slate-800" onclick="renameTeam()">Rename</button>
        <button class="px-3 py-2 text-sm rounded-lg bg-rose-600 text-white hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-rose-600" onclick="deleteTeam()">Delete</button>
      </div>
    </header>

    <!-- Panels grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Members & Attendance -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-4">Members & Attendance</h2>
        <div class="flex flex-col md:flex-row gap-3 mb-3">
          <input id="memberInput" type="text" placeholder="Add member (Enter)" class="flex-1 bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Add single member" />
          <button id="addMemberBtn" class="px-3 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">Add</button>
        </div>
        <details class="mb-4">
          <summary class="cursor-pointer text-sm text-slate-600 hover:text-slate-800">Bulk add (comma or newline separated)</summary>
          <div class="mt-2">
            <textarea id="bulkInput" rows="3" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. Alice, Bob, Charlie"></textarea>
            <div class="mt-2 flex gap-2">
              <button id="bulkAddBtn" class="px-3 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">Add All</button>
              <button id="bulkClearBtn" class="px-3 py-2 text-sm rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-300 rounded-lg">Clear</button>
            </div>
          </div>
        </details>

        <div id="memberChips" class="flex flex-wrap gap-2"></div>

        <div class="mt-4">
          <h3 class="text-sm font-medium text-slate-700 mb-2">Attendance (skip without deleting)</h3>
          <ul id="attendanceList" class="divide-y divide-slate-200 border border-slate-200 rounded-xl overflow-hidden bg-slate-50"></ul>
        </div>
      </section>

      <!-- Order, Roles & Timer -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Today's Order & Timer</h2>
          <div class="text-sm text-slate-500" id="todayLabel"></div>
        </div>

        <!-- Randomize options -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
          <label class="flex items-center gap-2 text-sm"><input id="deterministic" type="checkbox" class="rounded border-slate-300"> Deterministic by date</label>
          <label class="flex items-center gap-2 text-sm"><input id="avoidRepeatFirst" type="checkbox" class="rounded border-slate-300" checked> Avoid repeating yesterday's first</label>
          <label class="flex items-center gap-2 text-sm"><input id="roleFac" type="checkbox" class="rounded border-slate-300"> Assign Facilitator</label>
          <label class="flex items-center gap-2 text-sm"><input id="roleNote" type="checkbox" class="rounded border-slate-300"> Assign Note‚Äëtaker</label>
          <label class="flex items-center gap-2 text-sm"><input id="roleDemo" type="checkbox" class="rounded border-slate-300"> Assign Demo</label>
        </div>

        <div class="flex flex-wrap gap-2 mb-4">
          <button id="randomizeBtn" class="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-emerald-600">Randomize Order</button>
          <button id="copyOrderBtn" class="px-3 py-2 text-sm rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-300">Copy Order</button>
          <button id="resetOrderBtn" class="px-3 py-2 text-sm rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-300">Reset Order</button>
        </div>

        <ol id="orderList" class="list-decimal pl-5 space-y-1 mb-6"></ol>

        <!-- Timer Controls -->
        <div class="border border-slate-200 rounded-xl p-4">
          <div class="flex items-center justify-between gap-3 mb-3">
            <div class="text-sm text-slate-600">Per‚Äëperson seconds:</div>
            <input id="secondsInput" type="number" min="10" step="5" value="60" class="w-24 bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div class="flex items-center justify-between gap-3 mb-4">
            <div class="text-xl font-semibold" id="currentSpeaker">‚Äî</div>
            <div class="text-3xl tabular-nums" id="timerDisplay">00:60</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="startPauseBtn" class="px-3 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">Start</button>
            <button id="nextBtn" class="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-emerald-600">Next</button>
            <button id="resetBtn" class="px-3 py-2 text-sm rounded-lg bg-slate-800 text-white hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-slate-800">Reset</button>
          </div>
        </div>

        <!-- Notes -->
<div class="mt-4 border border-slate-200 rounded-xl p-4 bg-slate-50">
  <div class="flex items-center justify-between mb-2">
    <h3 class="text-sm font-medium text-slate-700">Notes for current speaker</h3>
    <div class="text-xs text-slate-500" id="notesMeta"></div>
  </div>
  <textarea id="notesTextarea" rows="5"
    class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
    placeholder="Type notes here‚Ä¶"></textarea>
  <div class="mt-2 flex gap-2">
    <button id="copyNotesBtn" class="px-3 py-2 text-sm rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-300">
      Copy Note
    </button>
    <button id="clearNotesBtn" class="px-3 py-2 text-sm rounded-lg bg-rose-50 text-rose-700 hover:bg-rose-100 border border-rose-200">
      Clear Note
    </button>
    <button id="copyMeetingNotesBtn" class="ml-auto px-3 py-2 text-sm rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-300">
      Copy All Notes Today
    </button>
  </div>
  <div class="mt-2 flex items-center gap-2">
  <button id="micToggleBtn"
    class="px-3 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-600">
    üéôÔ∏è Start Mic
  </button>
  <select id="micLang"
    class="bg-white border border-slate-300 rounded-lg px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="en-US">English (US)</option>
    <option value="en-GB">English (UK)</option>
    <option value="hi-IN">Hindi (India)</option>
    <option value="ar-AE">Arabic (UAE)</option>
    <option value="es-ES">Spanish (Spain)</option>
    <option value="fr-FR">French</option>
    <option value="de-DE">German</option>
    <!-- add/adjust to your audience -->
  </select>
  <span class="text-xs text-slate-500">Live speech ‚Üí notes</span>
</div>

</div>

      </section>
    </div>

    <footer class="mt-8 text-center text-xs text-slate-500">No sign‚Äëin. Everything is stored locally in your browser.</footer>
  </div>

  <script>
// ===== Analytics (Google Sheets) =====
const ANALYTICS_URL   = 'https://script.google.com/macros/s/AKfycbxHUvZBtHxlR6Qssr1N0hAtJhENCY1jqx4XI-lcwwy2b9Ej3rx9VJNbNqICvam6VoSZ/exec';
const ANALYTICS_TOKEN = '';           // optional; keep '' if you didn't set one in Apps Script
const APP_VERSION     = '1.0.0';

function getClientId(){
  let id = localStorage.getItem('standup_client_id');
  if (!id) { id = 'c_' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem('standup_client_id', id); }
  return id;
}

function track(event, payload = {}) {
  const cid   = getClientId();
  const date  = todayISO();
  const team  = (typeof currentTeam === 'function' && currentTeam()) ? (currentTeam().name || '') : '';
  const body  = {
    token: ANALYTICS_TOKEN,
    event,
    date,
    client_id: cid,
    session_id: `${date}:${cid}`,   // we are NOT deduping
    team,
    payload,
    app_version: APP_VERSION
  };
  enqueueEvent(body);
  flushEventQueue();
}

function enqueueEvent(ev){
  const q = JSON.parse(localStorage.getItem('standup_evt_q') || '[]');
  q.push(ev);
  localStorage.setItem('standup_evt_q', JSON.stringify(q));
}

async function flushEventQueue(){
  let q = JSON.parse(localStorage.getItem('standup_evt_q') || '[]');
  if (!q.length) return;
  try {
    while (q.length) {
      const ev = q[0];
      const ok = await sendEvent(ev);
      if (!ok) break;
      q.shift();
    }
  } finally {
    localStorage.setItem('standup_evt_q', JSON.stringify(q));
  }
}

function sendEvent(ev){
  if (navigator.sendBeacon) {
    const blob = new Blob([JSON.stringify(ev)], { type: 'text/plain' });
    const ok = navigator.sendBeacon(ANALYTICS_URL, blob);
    return Promise.resolve(ok);
  }
  return fetch(ANALYTICS_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(ev) })
    .then(() => true)
    .catch(() => false);
}
window.addEventListener('online', flushEventQueue);


    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const todayISO = () => new Date().toISOString().slice(0,10);

    function toast(msg, variant='info'){
      const wrap = document.getElementById('toastWrap');
      const bg = variant==='error' ? 'bg-rose-600' : variant==='ok' ? 'bg-emerald-600' : 'bg-slate-900';
      const el = document.createElement('div');
      el.className = `toast ${bg} text-white text-sm px-3 py-2 rounded-lg shadow`;
      el.textContent = msg;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .3s'; setTimeout(()=>el.remove(), 300); }, 1500);
    }

    // Simple seeded RNG (mulberry32)
    function mulberry32(seed){
      return function(){
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }
    function strHash(s){
      let h = 2166136261 >>> 0;
      for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
      return h >>> 0;
    }

    // UUID helper with fallback (some preview sandboxes block crypto.randomUUID)
    function uuid(){
      try { if (window.crypto && crypto.randomUUID) return crypto.randomUUID(); } catch(e){}
      return 'id-' + Math.random().toString(36).slice(2) + '-' + Date.now().toString(36);
    }

    // ===== State =====
    const LS_KEY = 'standupAppV1';
    let state = {
      teams: {}, // id -> {id,name,members:[{id,name,present}], order:{date,list,roles,firstHistory:{}}, timer:{per:60,index:0,remaining:null,running:false}}
      currentTeamId: null,
    };

    function load(){
      try{ const raw = localStorage.getItem(LS_KEY); if(raw){ state = JSON.parse(raw); } }catch(e){ console.warn('load fail', e); }
      if(!state || !state.teams || Object.keys(state.teams).length===0){
        const id = uuid();
        state = { teams: { [id]: emptyTeam(id, 'My Team') }, currentTeamId: id };
        save();
      }


    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  function emptyTeam(id, name){
  return {
    id, name,
    members: [],
    order: { date: '', list: [], roles: {}, firstHistory: {} },
    timer: { per:60, index:0, remaining:null, running:false, lastTick:null },
    notes: {} // <-- date -> { memberId: "note text" }
  };
}


    function currentTeam(){ return state.teams[state.currentTeamId]; }

    // ===== Team Management (exposed) =====
    function newTeam(){
      const name = prompt('New team name');
      if(!name) return;
      const id = uuid();
      state.teams[id] = emptyTeam(id, name.trim());
      state.currentTeamId = id;
      save();
      renderAll();
      toast('Team created', 'ok');
      track('team_created', { name: name.trim() });

    }
    function renameTeam(){
      const t = currentTeam(); if(!t) return;
      const name = prompt('Rename team', t.name);
      if(!name) return;
      t.name = name.trim(); save(); renderAll(); toast('Team renamed', 'ok');
    }
    function deleteTeam(){
      const t = currentTeam(); if(!t) return;
      if(!confirm(`Delete team "${t.name}"?`)) return;
      delete state.teams[t.id];
      const remaining = Object.keys(state.teams);
      state.currentTeamId = remaining[0] || null;
      if(!state.currentTeamId){
        const id = uuid();
        state.teams[id] = emptyTeam(id,'My Team');
        state.currentTeamId = id;
      }
      save(); renderAll(); toast('Team deleted','ok');
    }
    window.newTeam = newTeam; window.renameTeam = renameTeam; window.deleteTeam = deleteTeam;

 function switchTeam(id){
  state.currentTeamId = id;
  save();
  renderAll();
  track('session_start', { teamId: id, teamName: (state.teams[id]?.name) || '' });
}


    // ===== Member Ops =====
    function addMember(name){
      name = name.trim(); if(!name) return;
      const t = currentTeam();
      const exists = t.members.some(m=>m.name.toLowerCase()===name.toLowerCase());
      if(exists){ toast('Already exists'); return; }
      t.members.push({ id: uuid(), name, present: true });
      save(); renderMembers(); renderAttendance();
    }
    function addMembersBulk(text){
      const parts = text.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
      parts.forEach(n=>addMember(n));
    }
    function removeMember(id){
      const t = currentTeam();
      t.members = t.members.filter(m=>m.id!==id);
      // also clean from order
      if(t.order && Array.isArray(t.order.list)){
        t.order.list = t.order.list.filter(mid=>mid!==id);
      }
      save(); renderAll(); toast('Deleted','ok');
    }
    function togglePresent(id, present){
      const t = currentTeam();
      const m = t.members.find(x=>x.id===id); if(!m) return;
      m.present = present;
      save(); renderAttendance();
    }

    // ===== Order & Roles =====
    function getPresentMembers(){
      const t = currentTeam();
      return t.members.filter(m=>m.present);
    }
    function shuffleDeterministic(arr, seed){
      const rnd = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){ const j = Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    }
    function shuffleRandom(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    }
    function assignRoles(orderIds){
      const t = currentTeam();
      const wantFac = $('#roleFac').checked;
      const wantNote = $('#roleNote').checked;
      const wantDemo = $('#roleDemo').checked;
      const roles = {};
      const pick = (roleName) => {
        if(!roleName) return;
        if(orderIds.length===0) return;
        const idx = Math.min(orderIds.length-1, 0); // by default assign the first
        const id = orderIds[idx];
        roles[roleName] = id;
      };
      // Assign in order to first distinct people if possible
      let pool = orderIds.slice();
      function take(){ return pool.shift(); }
      if(wantFac && pool.length) roles['facilitator'] = take();
      if(wantNote && pool.length) roles['noteTaker'] = take();
      if(wantDemo && pool.length) roles['demo'] = take();
      t.order.roles = roles; save();
      return roles;
    }

    function randomizeOrder(){
      const t = currentTeam();
      const present = getPresentMembers().map(m=>m.id);
      if(present.length===0){ toast('No present members','error'); return; }
      const deterministic = $('#deterministic').checked;
      const avoidRepeat = $('#avoidRepeatFirst').checked;
      const date = todayISO();

      let orderIds;
      if(deterministic){
        const seed = strHash(date + '|' + t.id);
        orderIds = shuffleDeterministic(present, seed);
      } else {
        orderIds = shuffleRandom(present);
      }

      if(avoidRepeat){
        const yesterday = new Date(date); yesterday.setDate(yesterday.getDate()-1);
        const yISO = yesterday.toISOString().slice(0,10);
        const yFirst = t.order.firstHistory ? t.order.firstHistory[yISO] : null;
        if(yFirst && orderIds[0]===yFirst && orderIds.length>1){
          // swap first two
          [orderIds[0], orderIds[1]] = [orderIds[1], orderIds[0]];
        }
      }

      // Save history of first speaker
      if(!t.order.firstHistory) t.order.firstHistory = {};
      t.order.firstHistory[date] = orderIds[0];

      t.order.date = date;
      t.order.list = orderIds;
      assignRoles(orderIds.slice());
      // Reset timer to start
      t.timer.index = 0; t.timer.running=false; t.timer.remaining = null; t.timer.lastTick=null;
      save();
      renderOrder(); renderTimer();
      t.timer.meetingStartedAt = performance.now();
track('meeting_started', {
  count: orderIds.length,
  roles: t.order.roles || {},
  deterministic: !!document.getElementById('deterministic').checked
});


    }

    function resetOrder(){
      const t = currentTeam(); t.order.list = []; t.order.date=''; t.order.roles={}; save(); renderOrder(); toast('Order reset');
    }

    // ===== Timer =====
    let rafId = null;
    function formatSecs(s){ s = Math.max(0, Math.ceil(s)); const m = Math.floor(s/60).toString().padStart(2,'0'); const sec = (s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }

    function ensureTimerDefaults(){
      const t = currentTeam();
      if(!t.timer) t.timer = { per:60, index:0, remaining:null, running:false, lastTick:null };
    }

    function startPauseTimer(){
      const t = currentTeam(); ensureTimerDefaults();
      if(!t.order.list || t.order.list.length===0){ toast('Set today\'s order first','error'); return; }
      if(t.timer.running){ t.timer.running=false; save(); renderTimer(); return; }
      // start
      t.timer.running = true;
      if(t.timer.remaining==null){ t.timer.remaining = t.timer.per; }
      t.timer.lastTick = performance.now();
      save();
      tick();
      renderTimer();
    }

    function tick(){
      const t = currentTeam(); if(!t.timer.running){ cancelAnimationFrame(rafId); return; }
      const now = performance.now();
      const dt = (now - (t.timer.lastTick||now))/1000;
      t.timer.lastTick = now;
      t.timer.remaining = Math.max(0, (t.timer.remaining||0) - dt);
      renderTimerDisplay();
      if(t.timer.remaining<=0){
        // auto next
        nextSpeaker();
      }
      rafId = requestAnimationFrame(tick);
    }

    function nextSpeaker(){
      const t = currentTeam(); ensureTimerDefaults();
      if(!t.order.list || t.order.list.length===0){ toast('No order set','error'); return; }
      if(t.timer.index < t.order.list.length-1){
        t.timer.index++;
        t.timer.remaining = t.timer.per;
        t.timer.running = false; // require manual start
        save(); renderTimer();
      } else {
  t.timer.running=false;

  save(); renderTimer(); toast('All done','ok');
        const dur = Math.round(((performance.now() - (t.timer.meetingStartedAt || performance.now())) / 1000));
track('meeting_completed', {
  count: t.order.list.length,
  durationSec: isFinite(dur) ? dur : null
});

}
    }

    function resetTimer(){
      const t = currentTeam(); ensureTimerDefaults();
      t.timer.index = 0; t.timer.remaining = t.timer.per; t.timer.running=false; save(); renderTimer();
    }

    function updatePerSeconds(val){
      const t = currentTeam(); ensureTimerDefaults();
      const n = Math.max(5, parseInt(val||60,10));
      t.timer.per = n; if(t.timer.remaining==null) t.timer.remaining = n; save(); renderTimerDisplay();
    }

    // ===== Notes helpers =====
function ensureNotes(date){
  const t = currentTeam();
  if (!t.notes) t.notes = {};
  if (!t.notes[date]) t.notes[date] = {};
  return t.notes[date];
}
function getCurrentSpeakerId(){
  const t = currentTeam();
  return (t.order?.list || [])[t.timer.index || 0];
}
function renderNotes(){
  const t = currentTeam();
  const date = t.order?.date || todayISO();
  ensureNotes(date);
  const sp = getCurrentSpeakerId();
  const name = sp ? (t.members.find(x=>x.id===sp)?.name || '‚Äî') : '‚Äî';
  const note = (t.notes[date] && t.notes[date][sp]) || '';
  const meta = document.getElementById('notesMeta');
  const ta = document.getElementById('notesTextarea');
  if (meta) meta.textContent = date + (name !== '‚Äî' ? ` ‚Ä¢ ${name}` : '');
  if (ta) ta.value = note;
}
function setCurrentNote(val){
  const t = currentTeam();
  const date = t.order?.date || todayISO();
  ensureNotes(date);
  const sp = getCurrentSpeakerId();
  if (!sp) return;
  t.notes[date][sp] = val;
  save();
  // refresh badges in order list
  renderOrder();
}
function copySpeakerNote(memberId){
  const t = currentTeam();
  const date = t.order?.date || todayISO();
  const name = t.members.find(m=>m.id===memberId)?.name || '‚Äî';
  const note = (t.notes?.[date]?.[memberId]) || '';
  const text = `${name} (${date})\n${note || ''}`;
  navigator.clipboard.writeText(text)
    .then(()=> toast('Copied','ok'))
    .catch(()=> toast('Copy failed','error'));
}
function copyAllNotesToday(){
  const t = currentTeam();
  const date = t.order?.date || todayISO();
  const day = t.notes?.[date] || {};
  const lines = (t.order?.list || []).map(id => {
    const nm = t.members.find(m=>m.id===id)?.name || id;
    const nv = (day[id] || '').trim();
    return `${nm}: ${nv}`;
  }).join('\n');
  navigator.clipboard.writeText(lines)
    .then(()=> toast('Copied','ok'))
    .catch(()=> toast('Copy failed','error'));
}
// tiny debounce helper
function debounce(fn, wait){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a), wait); }; }


    // ===== Rendering =====
    function renderTeams(){
      const sel = $('#teamSelect'); sel.innerHTML = '';
      const ids = Object.keys(state.teams);
      if(!state.currentTeamId || !state.teams[state.currentTeamId]){
        state.currentTeamId = ids[0] || null; save();
      }
      ids.forEach(id=>{
        const t = state.teams[id];
        const opt = document.createElement('option');
        opt.value = t.id; opt.textContent = t.name; opt.selected = (t.id===state.currentTeamId);
        sel.appendChild(opt);
      });
    }

    function renderMembers(){
      const t = currentTeam();
      const chips = $('#memberChips'); chips.innerHTML='';
      t.members.forEach(m=>{
        const item = document.createElement('div');
        item.className = 'chip inline-flex items-center bg-slate-100 border border-slate-200 text-slate-800 px-2 py-1 rounded-lg';
        item.innerHTML = `<span class="text-sm">${escapeHtml(m.name)}</span>`;
        const x = document.createElement('button');
        x.className = 'chip-x'; x.setAttribute('aria-label', `Remove ${m.name}`);
        x.innerHTML = '‚úï';
        x.addEventListener('click', ()=> removeMember(m.id));
        item.appendChild(x);
        chips.appendChild(item);
      });
    }

    function renderAttendance(){
      const t = currentTeam(); const ul = $('#attendanceList'); ul.innerHTML='';
      t.members.forEach(m=>{
        const li = document.createElement('li');
        li.className='bg-white flex items-center justify-between px-3 py-2';
        li.innerHTML = `
          <div class="flex items-center gap-3">
            <input type="checkbox" ${m.present?'checked':''} class="rounded border-slate-300 attendanceCheck">
            <span>${escapeHtml(m.name)}</span>
          </div>
        `;
        const cb = li.querySelector('.attendanceCheck');
        cb.addEventListener('change', (e)=> togglePresent(m.id, e.target.checked));
        ul.appendChild(li);
      });
    }

    function renderOrder(){
        const t = currentTeam();
  const ol = $('#orderList'); ol.innerHTML='';
  const list = t.order?.list || [];
  const roles = t.order?.roles || {};
  const date = t.order?.date || todayISO();

  list.forEach((id)=>{
    const m = t.members.find(x=>x.id===id); if(!m) return;
    const roleBadges = [];
    if(roles.facilitator===id) roleBadges.push('<span class="ml-2 text-xs px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 border border-blue-200">Facilitator</span>');
    if(roles.noteTaker===id)   roleBadges.push('<span class="ml-1.5 text-xs px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 border border-amber-200">Note-taker</span>');
    if(roles.demo===id)        roleBadges.push('<span class="ml-1.5 text-xs px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 border border-emerald-200">Demo</span>');

    const hasNote = (t.notes && t.notes[date] && t.notes[date][id] && t.notes[date][id].trim().length>0);
    const noteBadge = hasNote ? '<span class="ml-1.5 text-[10px] px-1 rounded bg-slate-200 text-slate-700">üìù</span>' : '';

    const li = document.createElement('li');
    li.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <div><span>${escapeHtml(m.name)}</span>${roleBadges.join('')}${noteBadge}</div>
        <button class="text-xs px-2 py-1 border border-slate-300 rounded hover:bg-slate-100"
          title="Copy ${escapeHtml(m.name)}'s note"
          onclick="copySpeakerNote('${id}')">Copy note</button>
      </div>
    `;
    ol.appendChild(li);
  });
  $('#todayLabel').textContent = t.order?.date ? `For ${t.order.date}` : '‚Äî';
  renderTimer(); // keep timer in sync
    }

    function renderTimer(){
      const t = currentTeam(); ensureTimerDefaults();
      const list = t.order?.list || [];
      const idx = Math.min(t.timer.index || 0, Math.max(0, list.length-1));
      const curId = list[idx];
      const curName = curId ? (t.members.find(x=>x.id===curId)?.name || '‚Äî') : '‚Äî';
      $('#currentSpeaker').textContent = curName;
      $('#secondsInput').value = t.timer.per || 60;
      if(t.timer.remaining==null) t.timer.remaining = t.timer.per || 60;
      renderTimerDisplay();
      $('#startPauseBtn').textContent = t.timer.running ? 'Pause' : 'Start';
      renderNotes();

    }

    function renderTimerDisplay(){
      const t = currentTeam(); const s = t.timer?.remaining ?? t.timer?.per ?? 60;
      $('#timerDisplay').textContent = formatSecs(s);
    }

    // ===== Helpers =====
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }

    // ===== Copy =====
    async function copyOrder(){
      const t = currentTeam();
      const names = (t.order?.list||[]).map(id=> t.members.find(m=>m.id===id)?.name).filter(Boolean);
      const text = names.join('\n');
      try{ await navigator.clipboard.writeText(text); toast('Copied','ok'); } catch(e){ toast('Copy failed','error'); }
    }

    // ===== Events =====
    function bindEvents(){
      $('#teamSelect').addEventListener('change', (e)=> switchTeam(e.target.value));
      $('#addMemberBtn').addEventListener('click', ()=> { const val = $('#memberInput').value; addMember(val); $('#memberInput').value=''; $('#memberInput').focus(); });
      $('#memberInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addMemberBtn').click(); }});
      $('#bulkAddBtn').addEventListener('click', ()=>{ addMembersBulk($('#bulkInput').value); toast('Added','ok'); });
      $('#bulkClearBtn').addEventListener('click', ()=>{ $('#bulkInput').value=''; });

      $('#randomizeBtn').addEventListener('click', randomizeOrder);
      $('#copyOrderBtn').addEventListener('click', copyOrder);
      $('#resetOrderBtn').addEventListener('click', resetOrder);

      $('#startPauseBtn').addEventListener('click', startPauseTimer);
      $('#nextBtn').addEventListener('click', nextSpeaker);
      $('#resetBtn').addEventListener('click', resetTimer);
      $('#secondsInput').addEventListener('change', (e)=> updatePerSeconds(e.target.value));

      // Persist deterministic + avoidRepeat toggles per team
      ['deterministic','avoidRepeatFirst','roleFac','roleNote','roleDemo'].forEach(id=>{
        document.getElementById(id).addEventListener('change', ()=>{
          const t = currentTeam(); if(!t.options) t.options={}; t.options[id]=document.getElementById(id).checked; save();
        });
      });

      // Notes panel
const debounced = debounce((val)=> setCurrentNote(val), 300);
const ta = document.getElementById('notesTextarea');
if (ta) ta.addEventListener('input', (e)=> debounced(e.target.value));
const copyBtn = document.getElementById('copyNotesBtn');
if (copyBtn) copyBtn.addEventListener('click', ()=>{
  const t = currentTeam();
  const date = t.order?.date || todayISO();
  const sp = getCurrentSpeakerId();
  const name = sp ? (t.members.find(x=>x.id===sp)?.name || '‚Äî') : '‚Äî';
  const text = `${name} (${date})\n${document.getElementById('notesTextarea').value}`;
  navigator.clipboard.writeText(text).then(()=> toast('Copied','ok')).catch(()=> toast('Copy failed','error'));
});
const clearBtn = document.getElementById('clearNotesBtn');
if (clearBtn) clearBtn.addEventListener('click', ()=>{
  document.getElementById('notesTextarea').value = '';
  setCurrentNote('');
  toast('Deleted','ok');
});
const copyAllBtn = document.getElementById('copyMeetingNotesBtn');
if (copyAllBtn) copyAllBtn.addEventListener('click', copyAllNotesToday);
// Mic controls
      // ===== Mic state (declare early to avoid TDZ) =====
var mic = window.mic || {
  active: false,
  rec: null,
  lang: localStorage.getItem('standup_mic_lang') || (navigator.language || 'en-US')
};
window.mic = mic; // keep a single global

const micBtn = document.getElementById('micToggleBtn');
if (micBtn) micBtn.addEventListener('click', () => mic.active ? stopMic() : startMic());

const micLangSel = document.getElementById('micLang');
if (micLangSel) {
  // set current language
  micLangSel.value = mic.lang;
  micLangSel.addEventListener('change', (e) => {
    mic.lang = e.target.value;
    localStorage.setItem('standup_mic_lang', mic.lang);
    if (mic.active) { stopMic(); startMic(); } // restart with new language
  });
}

    }

    function restoreOptions(){
      const t = currentTeam(); if(!t.options) t.options={};
      ['deterministic','avoidRepeatFirst','roleFac','roleNote','roleDemo'].forEach(id=>{
        document.getElementById(id).checked = !!t.options[id];
      });
    }

    function renderAll(){
      renderTeams(); restoreOptions(); renderMembers(); renderAttendance(); renderOrder();
      document.getElementById('todayLabel').textContent = `For ${todayISO()}`;
    }

    // ===== Init =====
    load();
    bindEvents();
    renderAll();
    // ===== Init =====
load();
bindEvents();
renderAll();

// Log every page load as a session (no dedupe)
track('session_start', {
  teamId: state.currentTeamId,
  teamName: (currentTeam()?.name) || ''
});



function isSpeechApiSupported(){
  return ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
}

function createRecognizer(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SR();
  rec.lang = mic.lang;
  rec.continuous = true;        // keep listening
  rec.interimResults = true;    // we‚Äôll only commit final results
  rec.maxAlternatives = 1;

  rec.onresult = (e) => {
    let finalText = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const res = e.results[i];
      if (res.isFinal) finalText += res[0].transcript + ' ';
    }
    if (finalText.trim().length) appendToNotes(finalText);
  };

  rec.onerror = (evt) => {
    toast(`Mic error: ${evt.error}`, 'error');
  };

  rec.onend = () => {
    // some browsers stop after a while‚Äîauto-restart if still active
    if (mic.active) {
      try { rec.start(); } catch (_) {}
    }
  };

  return rec;
}

function appendToNotes(text){
  const ta = document.getElementById('notesTextarea');
  if (!ta) return;

  // Optional: prefix with current speaker if textarea is empty
  const t = currentTeam();
  const sp = getCurrentSpeakerId?.();
  const name = sp ? (t.members.find(x => x.id === sp)?.name || '') : '';

  if (!ta.value.trim() && name) {
    ta.value = `${name}: ${text.trim()} `;
  } else {
    ta.value = (ta.value + (ta.value.endsWith(' ') ? '' : ' ') + text.trim() + ' ');
  }
  // persist via your existing notes flow
  if (typeof setCurrentNote === 'function') setCurrentNote(ta.value);
}

function startMic(){
  if (!isSpeechApiSupported()) {
    toast('Speech to text not supported in this browser', 'error');
    return;
  }
  if (mic.rec) { try { mic.rec.stop(); } catch (_) {} }

  mic.active = true;
  mic.rec = createRecognizer();
  try {
    mic.rec.start();
    toast('Mic on', 'ok');
    const btn = document.getElementById('micToggleBtn');
    if (btn) btn.textContent = '‚è∏Ô∏é Stop Mic';
  } catch (e) {
    toast('Could not start mic', 'error');
  }
}

function stopMic(){
  mic.active = false;
  if (mic.rec) { try { mic.rec.stop(); } catch (_) {} }
  const btn = document.getElementById('micToggleBtn');
  if (btn) btn.textContent = 'üéôÔ∏è Start Mic';
}


  </script>
</body>
</html>
